##run fastqc on all fastq files
#fastqc <fastq_input_file>

for n in {1..2}
do 
for fastq in lane$n/*.fastq
do 
fastqc $fastq
done
done	





##run trimmomatic - both steps: (i)primers/adapters and (ii) low quality bases/reads

for n in {1..2}
do 

trimmomatic.sh PE -phred33 -threads 1 -trimlog \
lane$n/trimm_logfile lane$n/s-7-1.fastq lane$n/s-7-2.fastq \
lane$n/s-7-1.paired.fastq lane$n/s-7-1.unpaired.fastq \
lane$n/s-7-2.paired.fastq lane$n/s-7-2.unpaired.fastq \
ILLUMINACLIP:primers_adapters.fa:2:30:10 MINLEN:36 &&

trimmomatic.sh PE -phred33 -threads 1 -trimlog \
lane$n/trimm_logfile2 \
lane$n/s-7-1.paired.fastq lane$n/s-7-2.paired.fastq \
lane$n/s-7-1.trim.paired.fastq lane$n/s-7-1.trim.unpaired.fastq \
lane$n/s-7-2.trim.paired.fastq lane$n/s-7-2.trim.unpaired.fastq \
LEADING:3 TRAILING:3 SLIDINGWINDOW:4:15  MINLEN:36

done




###prepare indices and dictionary for the reference genome

samtools faidx Saccharomyces_cerevisiae.EF4.68.dna.toplevel.fa

bwa index -a is Saccharomyces_cerevisiae.EF4.68.dna.toplevel.fa

picard.sh CreateSequenceDictionary R=Saccharomyces_cerevisiae.EF4.68.dna.toplevel.fa O=Saccharomyces_cerevisiae.EF4.68.dna.toplevel.dict





###alignment to a reference genome with bwa

for n in {1..2}
do 
bwa mem -R '@RG\tID:'"$n"'\tLB:library\tPL:Illumina\tPU:lane'"$n"'\tSM:yeast' \
Saccharomyces_cerevisiae.EF4.68.dna.toplevel.fa \
lane$n/s-7-1.trim.paired.fastq lane$n/s-7-2.trim.paired.fastq | \
samtools view -b - | samtools sort - -o lane${n}_sorted.bam  && 

samtools index lane${n}_sorted.bam
done

picard.sh MergeSamFiles INPUT=lane1_sorted.bam INPUT=lane2_sorted.bam OUTPUT=library.bam

samtools index library.bam



###duplicate removal with picard
picard MarkDuplicates INPUT=library.bam OUTPUT=library_final.bam METRICS_FILE=dupl_metrics.txt
samtools index library_final.bam

###BAM qc with qualimap
qualimap bamqc -bam library_final.bam -outdir qualimap_report


#### coverage plot

cov <- read_table("mito_coverage", col_names = F) %>%
	rename( chr = X1, 
		pos = X2,
		cov = X3)

cov_flt <- read_table("mito_coverage_bq20_mq50", col_names = F) %>%
	rename( chr = X1, 
		pos = X2,
		cov_flt = X3)

cov %>%
	ggplot(aes(x=pos,y=cov)) +
	geom_line(linetype = "solid") 
	
cov %>%
	left_join( cov_flt, by = "pos" ) %>%
	ggplot( aes(x=cov, y=cov_flt) ) +
	geom_point()

	
cov %>%
	left_join( cov_flt, by = "pos" ) %>%
	ggplot( aes(x=pos) ) +
	geom_line( aes(y=cov), colour = "black" ) +
	geom_line( aes(y=cov_flt), colour = "light blue" ) 



###########Variant Calling

####GATK HC variant calling on chromosome I
gatk HaplotypeCaller -R Saccharomyces_cerevisiae.EF4.68.dna.toplevel.fa -I library_final.bam -L I -O gatk_variants_raw_I.vcf 

####GATK HC variant calling on chromosome I with bq 20 and mq 50 filters on bases/reads
gatk HaplotypeCaller -R Saccharomyces_cerevisiae.EF4.68.dna.toplevel.fa -I library_final.bam -L I -mbq 20 --minimum-mapping-quality 50 -O gatk_variants_raw_I_bq20_mq50.vcf 

####Select SNPs only from GATK HC vcf
gatk SelectVariants -R Saccharomyces_cerevisiae.EF4.68.dna.toplevel.fa --variant gatk_variants_raw_I_bq20_mq50.vcf  -O gatk_variants_raw_I_bq20_mq50_SNP.vcf --select-type SNP



####FreeBayes variant calling on chromosome I with bq 20 and mq 50 filters on bases/reads
freebayes -q 20 -m 50 -u -f Saccharomyces_cerevisiae.EF4.68.dna.toplevel.fa library_final.bam -r I > freebayes_variants_raw_I_bq20_mq50.vcf

####Select SNPs only from FreeBayes vcf
gatk SelectVariants -R Saccharomyces_cerevisiae.EF4.68.dna.toplevel.fa --variant freebayes_variants_raw_I_bq20_mq50.vcf -O freebayes_variants_raw_I_bq20_mq50_SNP.vcf --select-type SNP



####Compare the two bq/mq flt vcf with vcftools
vcftools --vcf gatk_variants_raw_I_bq20_mq50_SNP.vcf --diff freebayes_variants_raw_I_bq20_mq50_SNP.vcf --diff-site --out compare




######Filter variants
by INFO (variant) DP
cat gatk_variants_raw_I_bq20_mq50_SNP.vcf | vcf-annotate -f d=3/Q=20 > gatk_variants_I_flt.vcf

by FORMAT (individual) DP
vcftools --vcf gatk_variants_raw_I_bq20_mq50_SNP.vcf --min-meanDP 3 --minQ 20 --out gatk_variants_I_flt2 --recode --recode-INFO-all

































































































bwa mem -R '@RG\tID:1\tLB:library\tPL:Illumina\tPU:lane1\tSM:yeast' Saccharomyces_cerevisiae.EF4.68.dna.toplevel.fa lane1/s-7-1.trim.paired.fastq lane1/s-7-2.trim.paired.fastq | samtools view -b - | samtools sort - -o lane1_sorted.bam  && 
samtools index lane1_sorted.bam

bwa mem -R '@RG\tID:1\tLB:library\tPL:Illumina\tPU:lane2\tSM:yeast' Saccharomyces_cerevisiae.EF4.68.dna.toplevel.fa lane2/s-7-1.trim.paired.fastq lane2/s-7-2.trim.paired.fastq | samtools view -b - | samtools sort - -o lane2_sorted.bam  && 
samtools index lane2_sorted.bam






















